<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css" crossorigin="anonymous">
    <script type="module">
import kongUtil from 'https://cdn.jsdelivr.net/npm/kong-util/mod/all.mjs';
kongUtil.use();

const reader = new FileReader();
const thead = $('thead'), tbody = $('tbody');
const btnStop = $('button');
let intervalID;

listen($('[type=file]'), 'change', event => {
    stop();
    thead.textContent = tbody.textContent = '';

    const file = event.target.files[0];
    if(!file) return;
    console.log(file.type, file.size);
    reader.readAsText(file);
});

listen(reader, 'load', () => {
    const text = reader.result;
    console.log('file loaded', text.length);
    try {
        const records = parseCSV(text, false);
        console.log(records.length + ' records');
        const fields = records.shift();
        thead.append(createElement(
            {tr: {$: [
                {th: '#'},
                ...fields.map(th => ({th}))
            ]}}
        ));

        let counter = 0;
        intervalID = setInterval(() => {
            const record = records.shift();
            if(!record) return stop();
            try {
                tbody.append(createElement(
                    {tr: {$: [
                        {th: (++counter).toString()},
                        ...record.map(td => ({td}))
                    ]}}
                ));
            }
            catch(err) {
                stop(err);
            }
        }, 1);
        btnStop.classList.remove('d-none');
        btnStop.disabled = false;
    }
    catch(err) {
        stop(err);
    }
});

listen(btnStop, 'click', () => stop());

function stop(err) {
    if(err) console.error(err);
    clearInterval(intervalID);
    btnStop.disabled = true;
}
    </script>
</head>
<body>
    <h1>CSV</h1>
    <input type="file" title="file">
    <button type="button" class="btn btn-warning d-none">Stop</button>
    <table class="table table-dark table-striped-columns">
        <thead class="table-secondary"></thead>
        <tbody></tbody>
    </table>
</body>
</html>
