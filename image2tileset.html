<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>image to tileset</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/kong-util/dist/all.js"></script>
    <style>
        img {
            min-height: 2em;
        }
        ol {
            display: flex;
            flex-wrap: wrap;
        }
        li {
            margin: 0 2em 1em 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>image to tileset</h1>
        <div>
            <label>
                tile width
                <input type="number" min="2" value="16">
            </label>
        </div>
        <div>
            <label>
                image file
                <input type="file">
            </label>
            <span id="image-size"></span>
        </div>
        <div class="my-2">
            <progress value="0"></progress>
            <span id="progress-text"></span>
            <button type="button" class="d-none btn btn-info btn-sm">Stop</button>
        </div>
        <canvas id="fullImage" class="d-none"></canvas>
        <canvas id="tileset"></canvas>
        <code style="white-space: pre"></code>
        <ol></ol>
    </div>

    <script>
kongUtil.use();

const fullImage = $('#fullImage');
const fullContext = fullImage.getContext('2d');
const map = [];

const tileset = $('#tileset');
const tsx = tileset.getContext('2d');

let timerID;
let bitmap;
let amount, counter, unique_count;
let tile_width, tile_height;
let x, y;

listen($('[type=file]'), 'change', async(event) => {
    $('ol').replaceChildren();
    $('progress').value = 0;
    $('#progress-text').replaceChildren();
    $('#image-size').replaceChildren();
    fullImage.classList.add('d-none');
    map.splice(0);
    $('code').replaceChildren();
    if(!event.target.files.length) return;

    tile_width = tile_height = parseInt($('[type=number]').value);

    const file = event.target.files[0];
    if(!file.type.startsWith('image'))
        throw new TypeError('Selected file is not an image.');

    event.target.disabled = true;
    $('button').disabled = false;
    $('button').classList.remove('d-none');

    bitmap = await createImageBitmap(file);
    $('#image-size').textContent = bitmap.width + '\u00d7' + bitmap.height;

    fullImage.width = bitmap.width * 2;
    fullImage.height = bitmap.height * 2;
    fullImage.classList.remove('d-none');
    fullContext.drawImage(bitmap, 0, 0, bitmap.width, bitmap.height, 0, 0, bitmap.width * 2, bitmap.height * 2);
    fullContext.font = '16px monospace';
    fullContext.fillStyle = '#ffffff';
    fullContext.textAlign = 'start';
    fullContext.textBaseline = 'top';

    amount = Math.ceil(bitmap.width / tile_width) * Math.ceil(bitmap.height / tile_height);
    counter = unique_count = 0;
    x = y = 0;
    timerID = requestIdleCallback(checkTile);
});

listen($('button'), 'click', () => {
    if(timerID) cancelIdleCallback(timerID);
    timerID = null;
    $('[type=file]').disabled = false;
    $('button').disabled = true;
});

function checkTile() {
    const step = 65536 / tile_width / tile_height;

    for(let i = 0; i < step; ++i) {
        $('progress').value = counter / amount;
        $('#progress-text').textContent = `${counter} / ${amount}`;
        if(y >= bitmap.height) return createMap();

        const canvas = document.createElement('canvas');
        canvas.width = tile_width;
        canvas.height = tile_height;

        const context = canvas.getContext('2d');
        context.drawImage(bitmap, x, y, tile_width, tile_height, 0, 0, tile_width, tile_height);

        const dataURL = canvas.toDataURL('image/png');
        const existed = $(`img[src="${dataURL}"]`);
        let tileId;
        if(existed) tileId = parseInt(existed.dataset.tileId);
        else {
            tileId = unique_count;
            $('ol').append(createElementFromJsonML(
                ['li', {},
                    ['img', {
                        src: dataURL,
                        data: {tileId, x, y}
                    }]
                ]
            ));
            ++unique_count;
        }
        map.push(tileId);
        fullContext.fillText(tileId.toString(16), x * 2, y * 2);

        ++counter;
        x += tile_width;
        if(x >= bitmap.width) {
            x = 0;
            y += tile_height;
        }
    }
    timerID = requestIdleCallback(checkTile);
}

function createMap() {
    $('[type=file]').disabled = false;
    $('button').disabled = true;
    timerID = null;
    console.debug(map);

    const tiles = $$('ol img');
    tileset.width = tile_width * 16;
    tileset.height = Math.ceil(tiles.length / 16) * tile_height;
    $$('ol img').forEach((img, index) => {
        const tx = (index % 16) * tile_width;
        const ty = Math.floor(index / 16) * tile_height;
        tsx.drawImage(bitmap,
            img.dataset.x, img.dataset.y, tile_width, tile_height,
            tx, ty, tile_width, tile_height
        );
    });

    const columns = Math.ceil(bitmap.width / tile_width);
    map.forEach((tileId, index) => {
        $('code').textContent += (tileId + 1) + ',';
        if(index && !(index % columns)) $('code').textContent += '\n';
    });

    console.debug('end');
}

    </script>
</body>
</html>