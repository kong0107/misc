<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body>
    <h1>JSON</h1>
    <input type="file" title="file">
    <button type="button" class="btn btn-warning d-none">Stop</button>
    <table class="table table-dark table-striped-columns">
        <thead class="table-secondary sticky-top"></thead>
        <tbody></tbody>
    </table>

<script type="module">
import kongUtil from 'https://cdn.jsdelivr.net/npm/kong-util@0.5/mod/all.mjs';
kongUtil.use();

const reader = new FileReader();
const [thead, tbody] = $(['thead', 'tbody']);
const btnStop = $('button');
let callbackID, fields = [], records = [];

listen($('[type=file]'), 'change', event => {
    stop();
    thead.textContent = tbody.textContent = '';

    const file = event.target.files[0];
    if(!file) return;
    console.log(file.type, file.size);
    reader.readAsText(file);
});

listen(reader, 'load', () => {
    const text = reader.result;
    console.log('file loaded', text.length);
    try {
        records = JSON.parse(text);
        if(!Array.isArray(records)) return stop('not an array');
        console.log(records.length + ' records');

        fields = [];
        records.forEach(record => {
            Object.keys(record).forEach(key => {
                if(!fields.includes(key)) fields.push(key);
            });
        });
        thead.append(createElement(
            {tr: {$: [
                {th: '#'},
                ...fields.map(th => ({th}))
            ]}}
        ));
        callbackID = requestIdleCallback(showNextRecord);
        btnStop.classList.remove('d-none');
        btnStop.disabled = false;
    }
    catch(err) {
        stop(err);
    }
});

listen(btnStop, 'click', () => stop());

function showNextRecord() {
    const record = records.shift();
    if(!record) return stop();
    try {
        tbody.append(createElement(
            {tr: {$: [
                {th: (tbody.childElementCount + 1).toString()},
                ...fields.map(field => ({td: record[field]?.toString()}))
            ]}}
        ));
        callbackID = requestIdleCallback(showNextRecord);
    }
    catch(err) {
        stop(err);
    }
}

function stop(err) {
    if(err) console.error(err);
    cancelIdleCallback(callbackID);
    btnStop.disabled = true;
    records = [];
}
</script>
</body>
</html>
