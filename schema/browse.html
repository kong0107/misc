<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Definition of Schema.org (unofficial)</title>
    <base target="_blank">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,0,0" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" crossorigin="anonymous"></script>
    <style>
        body { background-color: #ccc; }
        p { margin-bottom: .5em; }
        dl { margin-bottom: .5em; }
        dd { padding-left: 1em; }
        details { padding: 0 0 .5em .5em; }
        details[open] { border-left: 1px solid #888; }
        details[open] > summary:not(:has(.badge:only-child)) {
            position: sticky;
            background-color: #fff;
            border-bottom-left-radius: .3em;
            padding: 0 .2em;
        }
        .material-symbols-outlined {
            -webkit-user-select: none;
            user-select: none;
            transform: scale(.8) translate(0, .3em);
            text-decoration: none;
        }
        /**
         * Bootstrap badge color mapping:
         * * primary: properties
         * * secondary: basic type
         * * success: `subClassOf`
         * * danger: superseded (inline)
         * * warning: enumeration (inline)
         * * info: members (for enumeration class)
         */
    </style>
</head>
<body class="container">
    <header>
        <h1 class="fs-5 m-0">
            Vocabulary Definition of
            <a href="https://schema.org/docs/developers.html#defs">Schema.org</a>
        </h1>
    </header>
    <main></main>
    <footer></footer>
    <script type="module">
console.time('load');
import kongUtil from 'https://cdn.jsdelivr.net/npm/kong-util/mod/all.mjs';
kongUtil.use();

// 嘗試抓同主機的，沒有的話就抓官方的。
const schema = await fetchJSON('schemaorg-current-https.jsonld')
    .catch(() => fetchJSON('https://schema.org/version/latest/schemaorg-current-https.jsonld'))
;

// 整理原始資料
const vocabulary = schema['@graph']
.map(term => {
    const obj = {};
    for(let prop in term) {
        let value = term[prop];
        switch(prop) {
            case '@id': {
                obj[prop] = value.substring(7);
                break;
            }
            case '@type':
            case 'rdfs:label': {
                obj[prop] = Array.isArray(value) ? value : [value];
                break;
            }
            case 'rdfs:comment': {
                if(typeof value !== 'string') value = value['@value'];
                let html = '<div>' + marked.parse(value.replace(/\\n/g, '\n')) + '</div>';
                html = html.replace(/\[\[(\w+)\]\]/g, '<a href="https://schema.org/$1">$1</a>');
                obj[prop] = parseHTML(html);
                break;
            }
            // 至多只會有一個值的
            case 'owl:equivalentProperty':
            case 'schema:inverseOf':
            case 'schema:isPartOf':
            case 'schema:sameAs':
            case 'schema:supersededBy':
            case 'skos:exactMatch': {
                obj[prop] = value['@id'];
                break;
            }
            // 有時只有一值，有時是陣列的
            case 'dcterms:source':
            case 'owl:equivalentClass':
            case 'rdfs:subClassOf':
            case 'rdfs:subPropertyOf':
            case 'schema:domainIncludes':
            case 'schema:rangeIncludes':
            case 'schema:source':
            case 'skos:closeMatch': {
                if(!Array.isArray(value)) value = [value];
                obj[prop] = value.map(item => item['@id']);
                break;
            }
            default: console.error('unknown property', prop);
        }
    }
    return obj;
})
.sort((a, b) => (a['@id'] < b['@id']) ? -1 : 1);

// 生成想要的資料
const classes = vocabulary.filter(term => term['@type'].includes('rdfs:Class'));

vocabulary.forEach(term => {
    term['schema:domainIncludes']?.forEach(className => {
        className = className.split(':')[1];
        const rdfsClass = classes.find(c => c['@id'] === className);
        rdfsClass.properties = rdfsClass.properties || [];
        rdfsClass.properties.push(term['@id']);
    });

    const enumName = term['@type'].find(t => t.startsWith('schema:'))?.split(':')[1];
    if(!enumName) return;
    const en = classes.find(c => c['@id'] === enumName);
    en.members = en.members || [];
    en.members.push(term['@id']);
});

// 建立與顯示
classes.forEach(term => $('main').append(createContainer(term)));

// 除錯用
globalThis.vocabulary = vocabulary;
requestIdleCallback(() => console.timeEnd('load'));


/**** 以下是函式宣告 ****/

function createContainer(term, depth = 0) {
    if(typeof term === 'string') term = classes.find(c => c['@id'] === term);

    const container = createElementFromJsonML(
        ['details', {},
            ['summary',
                {style: `top: ${depth * 1.7}em; z-index: ${100 - depth};`},
                term['@id'],
                term.hasOwnProperty('members')
                    ? ['span', {class: 'badge bg-warning text-dark'},
                        'Enumeration']
                    : ''
                ,
                ['a',
                    {
                        class: 'material-symbols-outlined',
                        href: 'https://schema.org/' + term['@id']
                    },
                    'open_in_new'
                ]
            ]
        ]
    );
    listen(container, 'toggle', () => {
        if(!term.hasOwnProperty('properties') && !term.hasOwnProperty('rdfs:subClassOf')) {
            container.append(createElementFromJsonML(
                ['div', {},
                    ['span',
                        {class: 'badge bg-secondary'},
                        'basic type'
                    ]
                ]
            ));
        }

        container.append(term['rdfs:comment'].cloneNode(true));

        if(term.hasOwnProperty('schema:supersededBy')) {
            const superseder = term['schema:supersededBy'].split(':')[1];
            container.append(createElementFromJsonML(
                ['div', {},
                    ['span',
                        {class: 'badge bg-danger'},
                        'supersededBy'
                    ]
                ]
            ));
            container.lastChild.append(createContainer(superseder, depth + 1));
        }

        if(term.hasOwnProperty('rdfs:subClassOf')) {
            container.append(createElementFromJsonML(
                ['details',
                    {open: ''},
                    ['summary', {},
                        ['span',
                            {class: 'badge bg-success'},
                            'subClassOf'
                        ]
                    ]
                ]
            ));
            term['rdfs:subClassOf'].forEach(parent => {
                container.lastChild.append(createContainer(parent.split(':')[1], depth + 1));
            });
        }

        if(term.hasOwnProperty('properties')) {
            container.append(createElementFromJsonML(
                ['details',
                    {open: ''},
                    ['summary', {},
                        ['span',
                            {class: 'badge bg-primary'},
                            'properties'
                        ]
                    ]
                ]
            ));
            term.properties.forEach(propName => {
                const prop = vocabulary.find(term => term['@id'] === propName);
                const dl = createElementFromJsonML(
                    ['dl', {},
                        ['dt', {},
                            propName,
                            ['a',
                                {
                                    class: 'material-symbols-outlined',
                                    href: 'https://schema.org/' + propName
                                },
                                'open_in_new'
                            ]
                        ]
                    ]
                );
                if(prop.hasOwnProperty('schema:supersededBy')) {
                    const superseder = prop['schema:supersededBy'].split(':')[1];
                    dl.append(createElementFromJsonML(
                        ['dd', {},
                            ['span',
                                {class: 'badge bg-danger'},
                                'supersededBy'
                            ],
                            superseder
                        ]
                    ));
                }
                dl.append(createElementFromJsonML(
                    ['dd', {}, prop['rdfs:comment']]
                ));
                prop['schema:rangeIncludes'].forEach(type => {
                    const className = type.split(':')[1];
                    dl.append(createElementFromJsonML(['dd']));
                    dl.lastChild.append(createContainer(className, depth + 1));
                });
                container.lastChild.append(dl);
            });
        }

        if(term.hasOwnProperty('members')) {
            container.append(createElementFromJsonML(
                ['details',
                    {open: ''},
                    ['summary', {},
                        ['span',
                            {class: 'badge bg-info'},
                            'members'
                        ]
                    ]
                ]
            ));
            term.members.forEach(mName => {
                const member = vocabulary.find(term => term['@id'] === mName);
                const dl = createElementFromJsonML(
                    ['dl', {},
                        ['dt', {},
                            mName,
                            ['a',
                                {
                                    class: 'material-symbols-outlined',
                                    href: 'https://schema.org/' + mName
                                },
                                'open_in_new'
                            ]
                        ]
                    ]
                );
                if(member.hasOwnProperty('schema:supersededBy')) {
                    const superseder = member['schema:supersededBy'].split(':')[1];
                    dl.append(createElementFromJsonML(
                        ['dd', {},
                            ['span',
                                {class: 'badge bg-danger'},
                                'supersededBy'
                            ],
                            superseder
                        ]
                    ));
                }
                dl.append(createElementFromJsonML(
                    ['dd', {}, member['rdfs:comment']]
                ));
                container.lastChild.append(dl);
            });
        }

    }, {once: true});
    return container;
}
    </script>
</body>
</html>
