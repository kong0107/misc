<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Definition of Schema.org (unofficial)</title>
    <base target="_blank">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,0,0" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" crossorigin="anonymous"></script>
    <style>
        [class^=link] { cursor: pointer; }
        .material-symbols-outlined { user-select: none }

        label,
        section dl:not([class~="rdfs:comment"]) dd {
            font-family: monospace;
        }

        main > section { display: none; } /* 後面再用更特定的選擇器讓其出現 */
    </style>
</head>
<body class="container">
    <header class="mb-3 pb-2 border-bottom">
        <h1 class="fs-3">
            Vocabulary Definition of
            <a href="https://schema.org/docs/developers.html#defs">Schema.org</a>
        </h1>
        <dl class="row">
            <dt class="col-md-3">search</dt>
            <dd class="col">
                <input type="text"
                    class="form-control"
                    placeholder="search vocabulary (case-insensitive)"
                >
            </dd>
        </dl>
        <dl class="row">
            <dt class="col-md-3">vocabulary to show</dt>
            <dd class="col row">
                <label class="col-md-6">
                    <input type="checkbox"
                        class="form-check-input me-1"
                        checked
                        disabled
                    >current
                </label>
                <label class="col-md-6">
                    <input type="checkbox"
                        class="form-check-input me-1"
                        checked
                    >superseded
                </label>
            </dd>
        </dl>
        <dl class="row">
            <dt class="col-md-3">types to show</dt>
            <dd class="col row">
                <label class="col-md-4">
                    <input type="checkbox"
                        class="form-check-input me-1"
                        checked
                    >rdfs:Class
                </label>
                <label class="col-md-4">
                    <input type="checkbox"
                        class="form-check-input me-1"
                        checked
                    >rdf:Property
                </label>
                <label class="col-md-4">
                    <input type="checkbox"
                        class="form-check-input me-1"
                        checked
                    >schema:*
                </label>
            </dd>
        </dl>
        <dl class="row">
            <dt class="col-md-3">properties to show</dt>
            <dd id="propertiesContainer" class="col row"></dd>
        </dl>
    </header>
    <main></main>
    <footer><nav class="nav"></nav></footer>
    <script type="module">
console.time('load schema');
import kongUtil from 'https://cdn.jsdelivr.net/npm/kong-util/mod/all.mjs';
kongUtil.use();

// 嘗試抓同主機的，沒有的話就抓官方的。
const schema = await fetchJSON('schemaorg-current-https.jsonld')
    .catch(() => fetchJSON('https://schema.org/version/latest/schemaorg-current-https.jsonld'))
;

// 先建好 <style> 們，需要時再套用／拿掉。（後面會再追加）
const styles = {
    'rdfs:Class': createElement({style: 'main > section[class~="rdfs:Class"] { display: block; }'}),
    'rdf:Property': createElement({style: 'main > section[class~="rdf:Property"] { display: block; }'}),
    'schema:*': createElement({style: 'main > section[class*="schema:"] { display: block; }'})
};
for(let prop in styles) document.head.append(styles[prop]);

Object.assign(styles, {
    superseded: createElement({style: '.superseded { display: none; }'})
});

// 所有要顯示的屬性
const properties = [
    '@id', '@type',
    'dcterms:source',
    'owl:equivalentClass', 'owl:equivalentProperty',
    'rdfs:label', 'rdfs:comment', 'rdfs:subClassOf', 'rdfs:subPropertyOf',
    'schema:domainIncludes', 'schema:inverseOf', 'schema:isPartOf',
    'schema:rangeIncludes', 'schema:sameAs', 'schema:source', 'schema:supersededBy',
    'skos:closeMatch', 'skos:exactMatch'
];

/**
 * 把所有屬性都：
 * 1. 在控制區建立 checkbox 。
 * 2. 建立（但暫不套用）隱藏對應屬性的 <style> 。
 */
properties.forEach(prop => {
    const labelElem = createElement(
        {label: {
            class: 'col-md-6 col-lg-4',
            $: [
                {input: {
                    type: 'checkbox',
                    class: 'form-check-input me-1',
                    checked: ''
                }},
                prop
            ]
        }}
    );
    if(prop === '@id') $('input', labelElem).disabled = true;
    $('#propertiesContainer').append(labelElem);
    Object.assign(styles, {
        [prop]: createElement(
            {style: `[class~="${prop}"] { display: none; }`}
        )
    });
});

/**
 * 核取方塊與對應的行為。
 * 有些是「勾起來時要隱藏別的」，有些則是「沒勾時要隱藏自己」。
 */
$$('header [type=checkbox]').forEach(checkbox => {
    const prop = checkbox.nextSibling.textContent.trim();
    if(checkbox.closest('#propertiesContainer') || prop === 'superseded') {
        listen(checkbox, 'click', () => {
            console.debug(prop);
            if(checkbox.checked) styles[prop].remove();
            else document.head.append(styles[prop]);
        });
    }
    else {
        listen(checkbox, 'click', () => {
            console.debug(prop);
            if(checkbox.checked) document.head.append(styles[prop]);
            else styles[prop].remove();
        });
    }
});

// 整理並建立用於顯示的資料結構
schema['@graph'].forEach(vocab => {
    // 確認沒有其他屬性
    for(let prop in vocab)
        if(!properties.includes(prop)) console.log(prop);

    // 先整理一下
    const id = vocab.id = vocab['@id'].substring(7);
    if(!Array.isArray(vocab['@type'])) vocab['@type'] = [vocab['@type']];

    // 開始建立資料結構
    const es = []; // elements
    es.push(
        {h2: {
            class: '@id fs-4',
            $: [
                id + ' ',
                {a: {
                    class: 'material-symbols-outlined text-decoration-none',
                    href: 'https://schema.org/' + id,
                    text: 'open_in_new'
                }}
            ]
        }}
    );

    // 若已被取代了，要優先警示。
    if(vocab.hasOwnProperty('schema:supersededBy')) {
        es.push(
            {dl: {
                class: 'schema:supersededBy row mb-0',
                $: [
                    {dt: {
                        class: 'col-md-4 col-lg-3',
                        $: [
                            {span: {
                                class: 'fs-6 fw-lighter text-secondary',
                                text: 'schema:'
                            }},
                            {span: {
                                class: 'badge bg-danger',
                                text: 'supersededBy'
                            }}
                        ]
                    }},
                    {dd: {
                        class: 'col',
                        $: createLinkFromName(vocab['schema:supersededBy'])
                    }}
                ]
            }}
        );
    }

    /**
     * 處理與顯示 @type ，
     * `rdf:Property` 和 `rdfs:Class` 著重在顯示 'Property' 和 'Class' ，
     * `schema:` 開頭的則著重顯示 'schema' 。
     */
    es.push(
        {dl: {
            class: '@type row mb-0',
            $: [
                {dt: {
                    class: 'col-md-4 col-lg-3',
                    $: [
                        {span: {
                            class: 'fs-6 fw-lighter text-secondary',
                            text: '@'
                        }},
                        {span: 'type'}
                    ]
                }},
                {dd: {
                    class: 'col',
                    $: [
                        {ul: {
                            class: 'list-inline',
                            $: vocab['@type'].map(type => {
                                const [category, name] = type.split(':');
                                if(category === 'schema') return {
                                    li: {$: [
                                        {span: {
                                            class: 'badge text-bg-success',
                                            text: 'schema'
                                        }},
                                        ':',
                                        {span: {
                                            class: 'vocabulary',
                                            text: name
                                        }}
                                    ]}
                                };
                                else return {
                                    li: {$: [
                                        category,
                                        ':',
                                        {span: {
                                            class: 'badge text-bg-' + (category === 'rdf' ? 'info' : 'warning'),
                                            text: name
                                        }}
                                    ]}
                                };
                            })
                        }}
                    ]
                }}
            ]
        }}
    );

    // `rdfs:comment` 要透過 markdown ，另外處理。
    es.push(
        {dl: {
            class: 'rdfs:comment row mb-0',
            $: [
                {dt: {
                    class: 'col-md-4 col-lg-3',
                    $: departPropertyName('rdfs:comment')
                }},
                {dd: {
                    class: 'col',
                    $: parseComment(vocab)
                }}
            ]
        }}
    );

    /**
     * 剩下的屬性們，可能的情形：
     * * 可能只有單一物件，也可能是一維陣列。
     * * 終端物件都是 { "@id": "xxxx" }
     * * 上述 "xxxx" 要嘛是 URL ，要嘛是 /\w+:\w+/ 格式。
     */
    [
        'dcterms:source',
        'owl:equivalentClass', 'owl:equivalentProperty',
        'rdfs:subClassOf', 'rdfs:subPropertyOf',
        'schema:domainIncludes', 'schema:inverseOf', 'schema:isPartOf',
        'schema:rangeIncludes', 'schema:sameAs', 'schema:source',
        'skos:closeMatch', 'skos:exactMatch'
    ].forEach(prop => {
        if(!vocab.hasOwnProperty(prop)) return;
        if(!Array.isArray(vocab[prop])) vocab[prop] = [vocab[prop]];
        es.push(
            {dl: {
                class: prop + ' row mb-0',
                $: [
                    {dt: {
                        class: 'col-md-4 col-lg-3',
                        $: departPropertyName(prop)
                    }},
                    {dd: {
                        class: 'col',
                        $: [
                            {ul: {
                                class: 'list-unstyled',
                                $: vocab[prop].map(obj => (
                                    {li: {$: createLinkFromName(obj)}}
                                ))
                            }}
                        ]
                    }}
                ]
            }}
        );
    });

    /**
     * 顯示到頁面上。
     * 因資料多可能造成頁面停滯，故用 `requestIdleCallback` 包起來。
     */
    requestIdleCallback(() => {
        const section = createElement(
            {section: {
                id,
                class: 'mb-4 pb-2 border-bottom'
                    + (vocab.hasOwnProperty('schema:supersededBy') ? ' superseded ' : ' ')
                    + vocab['@type'].join(' '),
                $: es
            }}
        );

        // 把 span.vocabulary 轉成可點選的物件。
        $$('.vocabulary', section).forEach(span => {
            span.classList.replace('vocabulary', 'link-primary');
            listen(span, 'click', () => scrollToId(span.textContent));
        });

        $('main').append(section);
    });
});

// 監看搜尋框，只顯示符合搜尋條件的資料。
listen($('[type=text]'), 'input', event => {
    /**
     * 拆解搜尋框的字串
     * 例如 'aa bb "cc dd ee" gg"hh'
     * 即應被拆解成 ['aa', 'bb', 'cc dd ee', 'gg"hh']
     */
    const needles = event.target.value.trim()
        .split(/\s+/).filter(x => x)
        .map(str => str.toLowerCase())
    ;
    let pos;
    while((pos = needles.findIndex(n => n.startsWith('"'))) !== -1) {
        const last = needles.findIndex((n, i) => {
            if(!n.endsWith('"') || i < pos) return false;
            if(i === pos && n.length === 1) return false; // '"'
            return true;
        });
        if(last === -1) break;
        const combinedNeedle = needles.slice(pos, last + 1).join(' ').slice(1, -1); // 移掉頭尾的雙引號
        if(combinedNeedle.length) needles.splice(pos, last - pos + 1, combinedNeedle);
        else needles.splice(pos, 1);
    }
    // console.debug(needles);

    // 資料建完前，某些元件還不存在，會觸發錯誤，故存取其他元件的動作要包在 requestIdleCallback 裡。
    requestIdleCallback(() => {
        schema['@graph'].forEach(voc => {
            $(`[id="${voc.id}"]`).style.display = searchInProperties(needles, voc) ? '' : 'none';
        });
    });
});

// 把 @context 的連結們放進 footer
for(let framework in schema['@context']) {
    const href = schema['@context'][framework];
    $('body > footer > nav').append(createElement(
        {a: {
            href,
            class: 'nav-link',
            text: framework
        }}
    ));
}

requestIdleCallback(() => console.timeEnd('load schema'));

/**** 以下是函式宣告 ****/

/**
 * @param {string[]} needles
 * @param {string|Array|Object} target
 * @returns {boolean}
 */
function searchInProperties(needles, target) {
    if(!needles.length) return true;
    if(typeof target === 'string')
        return needles.some(needle => target.toLowerCase().includes(needle));
    if(Array.isArray(target))
        return target.some(elem => searchInProperties(needles, elem));
    for(let prop in target) {
        if(searchInProperties(needles, target[prop])) return true;
    }
    return false;
}


/**
 * @param {String./\w+:\w/} str
 * @returns {JsonElement[2]}
 */
function departPropertyName(str) {
    const [category, name] = str.split(':');
    return [
        {span: {
            class: 'fs-6 fw-lighter text-secondary',
            text: category + ':'
        }},
        {span: name}
    ];
}

/**
 * @param {string} obj['@id']
 * @returns {JsonElement[1]}
 */
function createLinkFromName(obj) {
    const str = obj['@id'];
    const [category, name] = str.split(':');
    switch(category) {
        case 'http':
        case 'https':
            return [{a: {
                href: str,
                text: str
            }}];
        case 'schema':
            return [{span : {
                class: 'link-primary',
                text: str,
                onclick: () => scrollToId(name)
            }}];
        case 'foaf':
            return [{a: {
                href: `http://xmlns.com/foaf/0.1/#term_${name}`,
                text: str
            }}];
        case 'dcmitype':
            return [{a: {
                href: `https://www.dublincore.org/specifications/dublin-core/dcmi-terms/dcmitype/${name}/`,
                text: str
            }}];
        case 'dcterms':
            return [{a: {
                href: `https://www.dublincore.org/specifications/dublin-core/dcmi-terms/terms/${name}/`,
                text: str
            }}];
        case 'dcat':
            return [{a: {
                href: `https://www.w3.org/TR/vocab-dcat-3/#Class:${name}`,
                text: str
            }}];
        case 'rdf':
        case 'rdfs':
            return [{a: {
                href: 'https://www.w3.org/TR/2014/REC-rdf-schema-20140225/#ch_' + name.toLowerCase(),
                text: str
            }}];
        case 'void':
            return [{a: {
                href: 'https://www.w3.org/TR/void/',
                text: str
            }}];
        default:
            console.warn('unknown property', str);
            return [str];
    }
}

/**
 * @param {string|Array.<string>} vocab['rdfs:comment']
 * @returns {HTMLElement[]}
 */
function parseComment(vocab) {
    let md = (typeof vocab['rdfs:comment'] === 'string')
        ? vocab['rdfs:comment']
        : vocab['rdfs:comment']['@value']
    ;
    md = md.replace(/\\n/g, '\n');

    let html = '<div>' + marked.parse(md) + '</div>';
    html = html.replace(/\[\[(\w+)\]\]/g, '<span class="vocabulary">$1</span>');
    return [...parseHTML(html).childNodes];
}

/**
 * @param {string} id
 * @returns void
 */
function scrollToId(id) {
    $('[type=text]').value = '';
    $('[type=text]').dispatchEvent(new Event('input'));
    requestIdleCallback(() => {
        window.scroll(0, $(`[id="${id}"]`).offsetTop);
    });
}
    </script>
</body>
</html>
