<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sort Images for Print</title>
    <style type="text/css">
        :root {
            counter-reset: pager;
            scroll-behavior: smooth;
        }
        @media screen {
            body > header {
                position: sticky;
                top: 0;
                background: linear-gradient(#fff, #ffffff00);
            }
            h1 {
                margin: 0;
                cursor: pointer;
            }
            label {
                display: inline-block;
                padding: .2em .3em;
                border: 1px solid gray;
                border-radius: .2em;
                background-color: #eee;
                cursor: pointer;
            }
            [type=file] {
                display: none;
            }
            [type=checkbox] {
                position: relative;
            }
            [type=checkbox]::after {
                content: "顯示頁碼";
                position: absolute;
                left: 1.5em;
                width: 5em;
                top: -.2em;
            }

            .justify-content-between {
                display: flex;
                justify-content: space-between;
            }
            ol li {
                width: 400px;
                border-bottom: 1px dashed gray;
                padding-bottom: .5em;
                margin-bottom: .5em;
            }
            ol li:first-child .btn-move-top,
            ol li:first-child .btn-move-up,
            ol li:last-child .btn-move-down,
            ol li:last-child .btn-move-bottom {
                visibility: hidden;
            }
            img {
                max-width: 100%;
                max-height: 30vh;
            }
        }
        @media print {
            * {
                margin: 0;
                padding: 0;
            }
            header, footer, input {
                display: none;
            }
            li {
                list-style-type: none;
                height: 100vh;
                position: relative;
                font-size: 20px;
            }
            li:not(:first-child) {
                page-break-before: always;
            }
            img {
                max-width: 100vw;
                max-height: 100%;
                width: 100vw;
                object-fit: contain;
                margin: 0 auto;
                display: block;
            }

            [type=checkbox]:checked ~ ol li::after {
                counter-increment: pager;
                content: counter(pager);
                position: absolute;
                right: 0;
                bottom: 0;
                width: 100vw;
                text-align: center;
            }
            [type=checkbox]:checked ~ ol li img {
                max-height: calc(100% - 1.5em);
            }
        }
    </style>
    <script>
        const qs = document.querySelector.bind(document);

        function checkListEmptiness() {
            const display = qs("ol").childElementCount ? "" : "none";
            qs("#btn-sort").style.display = display;
            qs("#btn-clear").style.display = display;
        }

        function getItem(event) {
            let target = event.target;
            while(target.tagName != "LI") target = target.parentNode;
            return target;
        }
        const listeners = {
            "move-top": event => {
                const listItem = getItem(event);
                listItem.parentNode.insertAdjacentElement("afterbegin", listItem);
            },
            "move-up": event => {
                const listItem = getItem(event);
                const prevSib = listItem.previousSibling;
                if(prevSib) prevSib.insertAdjacentElement("beforebegin", listItem);

            },
            "move-down": event => {
                const listItem = getItem(event);
                const nextSib = listItem.nextSibling;
                if(nextSib) nextSib.insertAdjacentElement("afterend", listItem);
            },
            "move-bottom": event => {
                const listItem = getItem(event);
                listItem.parentNode.insertAdjacentElement("beforeend", listItem);
            },
            "remove": event => {
                getItem(event).remove();
                checkListEmptiness();
            }
        };

        document.addEventListener("DOMContentLoaded", () => {
            qs("h1").addEventListener("click", () => window.scrollTo(0,0));

            qs("[type=file]").addEventListener("change", event => {
                const container = qs("ol");
                for(const file of event.target.files) {
                    const listItem = qs("template").content.firstElementChild.cloneNode(true);
                    listItem.dataset.imageName = file.name;
                    listItem.querySelector(".txt-name").append(file.name);

                    for(let action in listeners) {
                        listItem.querySelector(`.btn-${action}`).addEventListener("click", listeners[action]);
                    }

                    listItem.querySelector("img").src = URL.createObjectURL(file);
                    container.append(listItem);
                }
                event.target.value = "";
                checkListEmptiness();
            });

            qs("#btn-print").addEventListener("click", window.print.bind(window));

            qs("#btn-sort").addEventListener("click", () => {
                console.debug("sort");
                const newList =
                    Array.from(qs("ol").children).sort((a, b) => {
                        const nameA = a.dataset.imageName;
                        const nameB = b.dataset.imageName;
                        return nameA.localeCompare(nameB);
                    })
                ;
                qs("ol").append(...newList);
            });

            qs("#btn-clear").addEventListener("click", () => {
                qs("ol").replaceWith(document.createElement("ol"));
                checkListEmptiness();
            });

            checkListEmptiness();
        });
    </script>
    <template>
        <li data-image-name>
            <header>
                <span class="txt-name"></span>
                <div class="justify-content-between">
                    <div>
                        <button title="move to top"    class="btn-move-top"   >⤒</button>
                        <button title="move up"        class="btn-move-up"    >↑</button>
                        <button title="move down"      class="btn-move-down"  >↓</button>
                        <button title="move to bottom" class="btn-move-bottom">⤓</button>
                    </div>
                    <button title="remove item" class="btn-remove">×</button>
                </div>
            </header>
            <img src>
        </li>
    </template>
</head>
<body>
    <header>
        <h1>Sort Images for Print</h1>

        <input id="input-file" type="file" multiple>
        <label id="btn-print">⎙ Print</label>
        <label id="btn-add" for="input-file">+ Add Images</label>
        <label id="btn-sort">↻ Sort by Name</label>
        <label id="btn-clear">⎚ Clear List</label>
    </header>

    <input type="checkbox">
    <ol></ol>

    <footer>
        <ul>
            <li>Only for PC browsers.</li>
            <li>列印時不會出現控制元件和說明文字。</li>
            <li>只在使用者電腦執行，圖片「不會」傳到網路上。</li>
            <li>可手動調整排序，也可依檔名排列。</li>
            <li>每頁只會有一張圖片。水平置中，但垂直置頂。</li>
            <li>圖片會等比例放大/縮小，到恰好滿足頁面高度或寬度（仍有頁面邊框）而不被裁切。</li>
            <li>可顯示或隱藏底部頁碼。</li>
        </ul>
    </footer>
</body>
</html>
