<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sort Images for Print</title>
    <style type="text/css">
        :root {
            counter-reset: pager;
        }
        @media screen {
            h1 {
                margin-top: 0;
            }
            label {
                display: inline-block;
                padding: .2em .3em;
                border: 1px solid gray;
                border-radius: .2em;
                background-color: #eee;
                cursor: pointer;
            }
            [type=file] {
                display: none;
            }
            [type=checkbox] {
                position: relative;
            }
            [type=checkbox]::after {
                content: "顯示頁碼";
                position: absolute;
                left: 1.5em;
                width: 5em;
                top: -.2em;
            }
            img {
                max-width: 80vw;
                max-height: 30vh;
            }
            li:first-child .btn-move-up,
            li:last-child .btn-move-down {
                border-color: transparent;
                color: transparent;
                background-color: transparent;
            }
        }
        @media print {
            * {
                margin: 0;
                padding: 0;
            }
            header, footer, input, .control-panel {
                display: none;
            }
            li {
                list-style-type: none;
                height: 100vh;
                position: relative;
                font-size: 20px;
            }
            li:not(:first-child) {
                page-break-before: always;
            }
            img {
                max-width: 100vw;
                max-height: 100%;
                width: 100vw;
                object-fit: contain;
                margin: 0 auto;
                display: block;
            }

            [type=checkbox]:checked ~ ol li::after {
                counter-increment: pager;
                content: counter(pager);
                position: absolute;
                right: 0;
                bottom: 0;
                width: 100vw;
                text-align: center;
            }
            [type=checkbox]:checked ~ ol li img {
                max-height: calc(100% - 1.5em);
            }
        }
    </style>
    <script>
        /// To do: 更方便的替換順序
        const d = document;
        const q = d.querySelector.bind(d);
        const e = d.createElement.bind(d);

        function checkListEmptiness() {
            const display = q("ol").childElementCount ? "" : "none";
            q("#btn-sort").style.display = display;
            q("#btn-clear").style.display = display;
        }

        d.addEventListener("DOMContentLoaded", () => {
            q("[type=file]").addEventListener("change", event => {
                const container = q("ol");
                for(const file of event.target.files) {
                    const listItem = e("li");

                    const controlPanel = e("div");
                    controlPanel.className = "control-panel";

                    const spanImgName = e("span");
                    spanImgName.append(d.createTextNode(file.name));

                    const btnMoveUp = e("button");
                    btnMoveUp.className = "btn-move-up";
                    btnMoveUp.textContent = "↑";
                    btnMoveUp.addEventListener("click", () => {
                        const prevSibling = listItem.previousSibling;
                        if(prevSibling) container.insertBefore(listItem, prevSibling);
                    });

                    const btnMoveDown = e("button");
                    btnMoveDown.className = "btn-move-down";
                    btnMoveDown.textContent = "↓";
                    btnMoveDown.addEventListener("click", () => {
                        const nextSibling = listItem.nextSibling;
                        if(nextSibling) container.insertBefore(nextSibling, listItem);
                    });

                    const btnRemove = e("button");
                    btnRemove.textContent = "×";
                    btnRemove.addEventListener("click", () => {
                        listItem.remove();
                        checkListEmptiness();
                    });

                    const image = e("img");
                    image.src = URL.createObjectURL(file);

                    controlPanel.append(btnMoveUp, btnMoveDown, spanImgName, btnRemove);
                    listItem.append(controlPanel, image);
                    container.append(listItem);
                }

                event.target.value = "";
                checkListEmptiness();
            });

            q("#btn-print").addEventListener("click", window.print.bind(window));

            q("#btn-sort").addEventListener("click", () => {
                console.debug("sort");
                const newList =
                    Array.from(q("ol").children).sort((a, b) => {
                        const nameA = a.querySelector("span").textContent;
                        const nameB = b.querySelector("span").textContent;
                        return nameA.localeCompare(nameB);
                    })
                ;
                q("ol").append(...newList);
            });

            q("#btn-clear").addEventListener("click", () => {
                q("ol").textContent = "";
                checkListEmptiness();
            });

            checkListEmptiness();
        });
    </script>
</head>
<body>
    <header>
        <h1>Sort Images for Print</h1>

        <input id="input-file" type="file" multiple>
        <label id="btn-print">⎙ Print</label>
        <label id="btn-add" for="input-file">+ Add Images</label>
        <label id="btn-sort">↻ Sort by Name</label>
        <label id="btn-clear">⎚ Clear List</label>
    </header>

    <input type="checkbox">
    <ol></ol>

    <footer>
        <ul>
            <li>Only for PC browsers.</li>
            <li>列印時不會出現控制元件和說明文字。</li>
            <li>只在使用者電腦執行，圖片「不會」傳到網路上。</li>
            <li>可手動調整排序，也可依檔名排列。</li>
            <li>每頁只會有一張圖片。水平置中，但垂直置頂。</li>
            <li>圖片會等比例放大/縮小，到恰好滿足頁面高度或寬度（仍有頁面邊框）而不被裁切。</li>
            <li>可顯示或隱藏底部頁碼。</li>
        </ul>
    </footer>
</body>
</html>
